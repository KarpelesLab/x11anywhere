name: Visual Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  visual-test-linux:
    name: Visual Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-apps imagemagick libxcb1-dev libxcb-shm0-dev

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build x11anywhere
        run: cargo build --release

      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1024x768x24 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 2
        env:
          DISPLAY: :99

      - name: Create test output directory
        run: mkdir -p visual_output

      - name: Start x11anywhere server
        run: |
          DISPLAY=:99 ./target/release/x11anywhere -display 99 -tcp &
          echo "X11ANYWHERE_PID=$!" >> $GITHUB_ENV
          sleep 2
        env:
          DISPLAY: :99

      - name: Run visual test
        run: |
          DISPLAY=:99 cargo test --test visual_test -- --nocapture
        env:
          DISPLAY: :99
          VISUAL_TEST_OUTPUT: ${{ github.workspace }}/visual_output

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-linux-screenshots
          path: visual_output/*.png
          if-no-files-found: warn

      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$X11ANYWHERE_PID" ]; then kill $X11ANYWHERE_PID || true; fi
          if [ ! -z "$XVFB_PID" ]; then kill $XVFB_PID || true; fi

  visual-test-macos:
    name: Visual Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Setup Swift
        run: |
          swift --version
          # Swift is pre-installed on macOS runners

      - name: Build Swift backend
        run: |
          cd swift
          swift build -c release

      - name: Build x11anywhere
        run: cargo build --release --features backend-macos

      # Note: macOS GitHub Actions runners don't have a display server
      # We'll need to skip the actual visual test or use a virtual display
      - name: Create test output directory
        run: mkdir -p visual_output

      - name: Start x11anywhere server
        run: |
          RUST_LOG=debug ./target/release/x11anywhere -display 1 -tcp > /tmp/x11anywhere_server.log 2>&1 &
          echo "X11ANYWHERE_PID=$!" >> $GITHUB_ENV
          sleep 2

      - name: Run visual test
        run: cargo test --test visual_test -- --nocapture
        env:
          VISUAL_TEST_OUTPUT: ${{ github.workspace }}/visual_output
          DISPLAY: :1

      - name: Copy debug images
        if: always()
        run: |
          cp /tmp/x11anywhere_debug_*.png visual_output/ 2>/dev/null || true
          cp /tmp/x11anywhere_buffer_*.png visual_output/ 2>/dev/null || true
          cp /tmp/x11anywhere_debug.log visual_output/ 2>/dev/null || true
          cp /tmp/x11anywhere_server.log visual_output/ 2>/dev/null || true
          echo "=== Contents of visual_output ==="
          ls -la visual_output/ || true
          echo "=== X11 files in /tmp ==="
          ls -la /tmp/x11anywhere* 2>/dev/null || true
          echo "=== Debug log content ==="
          cat /tmp/x11anywhere_debug.log 2>/dev/null || echo "No debug log found"
          echo "=== Server log content ==="
          cat /tmp/x11anywhere_server.log 2>/dev/null || echo "No server log found"

      - name: Show server output
        if: always()
        run: |
          # Check system log for our app
          log show --predicate 'process == "x11anywhere"' --last 5m 2>/dev/null || true

      - name: Cleanup
        if: always()
        run: kill $X11ANYWHERE_PID || true

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-macos-screenshots
          path: visual_output/*.png
          if-no-files-found: warn

  visual-test-windows:
    name: Visual Test (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build x11anywhere
        run: cargo build --release --features backend-windows

      # Windows GitHub Actions runners have a display
      - name: Create test output directory
        run: mkdir visual_output

      - name: Start server and run visual test
        shell: powershell
        run: |
          # Start server in background job (stays alive within this step)
          $env:RUST_LOG = "debug"
          Write-Host "Starting x11anywhere server..."
          $serverJob = Start-Job -ScriptBlock {
            param($workdir)
            Set-Location $workdir
            & ".\target\release\x11anywhere.exe" "-display" "1" "-tcp" 2>&1
          } -ArgumentList (Get-Location)

          # Wait for server to start
          Start-Sleep -Seconds 3

          # Check if server is running
          Write-Host "Checking server job status..."
          Receive-Job -Job $serverJob -Keep

          # Check if port is listening
          Write-Host "Checking port 6001..."
          netstat -an | Select-String "6001"

          # Run the visual test
          Write-Host "Running visual test..."
          cargo test --test visual_test -- --nocapture
          $testExitCode = $LASTEXITCODE

          # Show server output
          Write-Host "Server output:"
          Receive-Job -Job $serverJob

          # Clean up
          Stop-Job -Job $serverJob
          Remove-Job -Job $serverJob

          exit $testExitCode
        env:
          VISUAL_TEST_OUTPUT: ${{ github.workspace }}/visual_output
          DISPLAY: :1

      - name: Show server logs
        if: always()
        shell: powershell
        run: |
          if (Test-Path "server_stdout.log") { Get-Content "server_stdout.log" }
          if (Test-Path "server_stderr.log") { Get-Content "server_stderr.log" }

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-test-windows-screenshots
          path: visual_output/*.png
          if-no-files-found: warn

      - name: Cleanup
        if: always()
        shell: powershell
        run: |
          Get-Process x11anywhere -ErrorAction SilentlyContinue | Stop-Process -Force

  # Job to commit screenshots to the repository (only on push to master/main)
  commit-screenshots:
    name: Commit Screenshots
    runs-on: ubuntu-latest
    needs: [visual-test-linux, visual-test-macos, visual-test-windows]
    # Run even if Windows fails (it's flaky on GitHub Actions)
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
      needs.visual-test-linux.result == 'success' &&
      needs.visual-test-macos.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux screenshots
        uses: actions/download-artifact@v4
        with:
          name: visual-test-linux-screenshots
          path: docs/screenshots/linux
        continue-on-error: true

      - name: Download macOS screenshots
        uses: actions/download-artifact@v4
        with:
          name: visual-test-macos-screenshots
          path: docs/screenshots/macos
        continue-on-error: true

      - name: Download Windows screenshots
        uses: actions/download-artifact@v4
        with:
          name: visual-test-windows-screenshots
          path: docs/screenshots/windows
        continue-on-error: true

      - name: List downloaded files
        run: |
          echo "=== Downloaded screenshots ==="
          find docs/screenshots -type f -name "*.png" | head -20
          echo ""
          echo "=== Git status before add ==="
          git status
          echo ""
          echo "=== Current commit ==="
          git log -1 --oneline

      - name: Commit and push screenshots
        uses: EndBug/add-and-commit@v9
        with:
          add: "docs/screenshots"
          message: "Update visual test screenshots from CI"
          default_author: github_actions
