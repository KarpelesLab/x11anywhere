name: X11 Apps Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  xorg-apps-linux:
    name: X11 Apps Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            x11-apps \
            x11-utils \
            imagemagick \
            libxcb1-dev \
            libxcb-shm0-dev \
            xterm \
            xfonts-base \
            xfonts-100dpi \
            xfonts-75dpi

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build x11anywhere
        run: cargo build --release

      - name: Create output directories
        run: |
          mkdir -p xorg_apps_output/linux
          mkdir -p /tmp/x11anywhere_logs

      - name: Start Xvfb (for x11anywhere backend)
        run: |
          # Start Xvfb with -ac (access control disabled) for easier testing
          Xvfb :99 -screen 0 1280x1024x24 -ac &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          sleep 3
          # Verify Xvfb is running
          if ! kill -0 $XVFB_PID 2>/dev/null; then
            echo "ERROR: Xvfb failed to start"
            exit 1
          fi
          # Test that Xvfb is accepting connections
          if DISPLAY=:99 xdpyinfo >/dev/null 2>&1; then
            echo "Xvfb is running and accepting connections on :99"
          else
            echo "WARNING: Xvfb may not be ready"
          fi

      - name: Start x11anywhere server
        run: |
          # Run server with debug logging
          DISPLAY=:99 RUST_LOG=debug ./target/release/x11anywhere -display 50 -tcp > /tmp/x11anywhere_logs/server.log 2>&1 &
          echo "X11ANYWHERE_PID=$!" >> $GITHUB_ENV
          sleep 5

          # Check if port is listening (more reliable than PID check)
          echo "Checking if x11anywhere is listening on port 6050..."
          for i in 1 2 3 4 5; do
            if ss -tlnp 2>/dev/null | grep -q ":6050 " || netstat -tlnp 2>/dev/null | grep -q ":6050 "; then
              echo "x11anywhere is listening on port 6050"
              break
            fi
            echo "Waiting for server... (attempt $i)"
            sleep 2
          done

          # Also check PID as backup
          if ! kill -0 $X11ANYWHERE_PID 2>/dev/null; then
            echo "WARNING: Server process not found by PID"
            echo "=== Server log ==="
            cat /tmp/x11anywhere_logs/server.log
            # Don't exit yet - check port
          fi

          # Final port check
          if ss -tlnp 2>/dev/null | grep -q ":6050 " || netstat -tlnp 2>/dev/null | grep -q ":6050 "; then
            echo "x11anywhere server started successfully on display :50"
          else
            echo "ERROR: x11anywhere is not listening on port 6050"
            echo "=== Server log ==="
            cat /tmp/x11anywhere_logs/server.log
            exit 1
          fi

      - name: Test xclock
        run: |
          echo "Starting xclock..."
          DISPLAY=:50 xclock -geometry 200x200+50+50 &
          XCLOCK_PID=$!
          sleep 3
          # Capture screenshot via Xvfb
          DISPLAY=:99 import -window root xorg_apps_output/linux/xclock.png
          kill $XCLOCK_PID 2>/dev/null || true
          echo "xclock screenshot captured"

      - name: Test xeyes
        run: |
          echo "Starting xeyes..."
          DISPLAY=:50 xeyes -geometry 200x150+300+50 &
          XEYES_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xeyes.png
          kill $XEYES_PID 2>/dev/null || true
          echo "xeyes screenshot captured"

      - name: Test xlogo
        run: |
          echo "Starting xlogo..."
          DISPLAY=:50 xlogo -geometry 200x200+550+50 &
          XLOGO_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xlogo.png
          kill $XLOGO_PID 2>/dev/null || true
          echo "xlogo screenshot captured"

      - name: Test xcalc
        run: |
          echo "Starting xcalc..."
          DISPLAY=:50 xcalc -geometry 250x300+50+300 &
          XCALC_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xcalc.png
          kill $XCALC_PID 2>/dev/null || true
          echo "xcalc screenshot captured"

      - name: Test xterm
        run: |
          echo "Starting xterm..."
          DISPLAY=:50 xterm -geometry 80x24+350+300 -e "echo 'Hello from xterm running on x11anywhere!'; sleep 5" &
          XTERM_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xterm.png
          kill $XTERM_PID 2>/dev/null || true
          echo "xterm screenshot captured"

      - name: Test multiple apps together
        run: |
          echo "Starting multiple apps..."
          DISPLAY=:50 xclock -geometry 150x150+50+50 &
          PID1=$!
          DISPLAY=:50 xeyes -geometry 150x100+250+50 &
          PID2=$!
          DISPLAY=:50 xlogo -geometry 150x150+450+50 &
          PID3=$!
          sleep 3
          DISPLAY=:99 import -window root xorg_apps_output/linux/multiple_apps.png
          kill $PID1 $PID2 $PID3 2>/dev/null || true
          echo "multiple apps screenshot captured"

      - name: Show server logs
        if: always()
        run: |
          echo "=== x11anywhere server log ==="
          cat /tmp/x11anywhere_logs/server.log || true

      - name: Cleanup
        if: always()
        run: |
          kill $X11ANYWHERE_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-linux-screenshots
          path: xorg_apps_output/linux/*.png
          if-no-files-found: warn

  xorg-apps-macos:
    name: X11 Apps Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install XQuartz and X11 apps
        run: |
          # Install XQuartz which provides X11 libraries
          brew install --cask xquartz
          # Install X11 apps via Homebrew
          brew install xorg-apps || true
          # The libs are in /opt/X11 after XQuartz install

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Setup Swift
        run: swift --version

      - name: Build Swift backend
        run: |
          cd swift
          swift build -c release

      - name: Build x11anywhere
        run: cargo build --release --features backend-macos

      - name: Create output directories
        run: |
          mkdir -p xorg_apps_output/macos
          mkdir -p /tmp/x11anywhere_logs

      - name: Start x11anywhere server
        run: |
          RUST_LOG=info ./target/release/x11anywhere -display 50 -tcp > /tmp/x11anywhere_logs/server.log 2>&1 &
          echo "X11ANYWHERE_PID=$!" >> $GITHUB_ENV
          sleep 5
          echo "x11anywhere server started"

      - name: Test with X11 apps (if available)
        run: |
          # Check if XQuartz X11 apps are available
          if [ -x /opt/X11/bin/xclock ]; then
            echo "Starting xclock..."
            DISPLAY=:50 /opt/X11/bin/xclock -geometry 200x200+50+50 &
            XCLOCK_PID=$!
            sleep 3
            # Use macOS screencapture
            screencapture -x xorg_apps_output/macos/xclock.png
            kill $XCLOCK_PID 2>/dev/null || true
          else
            echo "XQuartz apps not found, skipping X11 app tests"
            # Create placeholder
            echo "XQuartz not available" > xorg_apps_output/macos/not_available.txt
          fi

      - name: Test xeyes (if available)
        run: |
          if [ -x /opt/X11/bin/xeyes ]; then
            echo "Starting xeyes..."
            DISPLAY=:50 /opt/X11/bin/xeyes -geometry 200x150+300+50 &
            XEYES_PID=$!
            sleep 2
            screencapture -x xorg_apps_output/macos/xeyes.png
            kill $XEYES_PID 2>/dev/null || true
          fi
        continue-on-error: true

      - name: Show server logs
        if: always()
        run: |
          echo "=== x11anywhere server log ==="
          cat /tmp/x11anywhere_logs/server.log || true

      - name: Cleanup
        if: always()
        run: kill $X11ANYWHERE_PID 2>/dev/null || true

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-macos-screenshots
          path: xorg_apps_output/macos/*
          if-no-files-found: warn

  xorg-apps-windows:
    name: X11 Apps Test (Windows)
    runs-on: windows-latest
    # Note: X11 client apps (xclock, xeyes, etc.) are not natively available on Windows.
    # This job tests that the x11anywhere server starts correctly on Windows.
    # The visual_test.rs tests provide actual X11 protocol testing on Windows.
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build x11anywhere (Windows native)
        run: cargo build --release --features backend-windows

      - name: Create output directories
        run: |
          New-Item -ItemType Directory -Force -Path xorg_apps_output/windows
          New-Item -ItemType Directory -Force -Path C:\temp\x11anywhere_logs

      - name: Start x11anywhere server
        run: |
          $env:RUST_LOG = "debug"
          # Start process and capture it
          $proc = Start-Process -FilePath ".\target\release\x11anywhere.exe" -ArgumentList "-display", "50", "-tcp" -RedirectStandardOutput "C:\temp\x11anywhere_logs\server_stdout.log" -RedirectStandardError "C:\temp\x11anywhere_logs\server_stderr.log" -PassThru
          Write-Host "Started x11anywhere with PID: $($proc.Id)"
          $proc.Id | Out-File -FilePath "C:\temp\x11anywhere_logs\server.pid"

          # Wait for server to start
          Start-Sleep -Seconds 5

          # Check if port is listening (multiple attempts)
          $success = $false
          for ($i = 1; $i -le 5; $i++) {
            $listening = netstat -an | Select-String "6050" | Select-String "LISTENING"
            if ($listening) {
              Write-Host "Server is listening on port 6050"
              $success = $true
              break
            }
            Write-Host "Waiting for server to start (attempt $i)..."
            Start-Sleep -Seconds 2
          }

          if (-not $success) {
            Write-Host "WARNING: Port 6050 not in LISTENING state after waiting"
            netstat -an | Select-String "6050"
          }

      - name: Verify server is running
        run: |
          Start-Sleep -Seconds 2

          # First check by port (more reliable)
          $listening = netstat -an | Select-String "6050" | Select-String "LISTENING"
          if ($listening) {
            Write-Host "Server is listening on port 6050 - verification passed"
          } else {
            Write-Host "WARNING: Port 6050 not found listening"
            # Show what's happening with the port
            netstat -an | Select-String "6050"
          }

          # Also try to find the process
          $process = Get-Process | Where-Object { $_.ProcessName -like "*x11*" } -ErrorAction SilentlyContinue
          if ($process) {
            Write-Host "Found process: $($process.ProcessName) (PID: $($process.Id))"
          } else {
            Write-Host "WARNING: x11anywhere process not found"
            # Show logs for debugging
            Write-Host "=== Server stderr ==="
            if (Test-Path "C:\temp\x11anywhere_logs\server_stderr.log") {
              Get-Content "C:\temp\x11anywhere_logs\server_stderr.log" -Tail 50
            }
          }

          # Final check - only fail if port is not listening AND no process found
          if (-not $listening -and -not $process) {
            Write-Host "ERROR: Server verification failed - neither port listening nor process found"
            exit 1
          }

      - name: Capture desktop screenshot
        run: |
          Start-Sleep -Seconds 2
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bitmap = New-Object System.Drawing.Bitmap($screen.Bounds.Width, $screen.Bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($screen.Bounds.Location, [System.Drawing.Point]::Empty, $screen.Bounds.Size)
          $bitmap.Save("xorg_apps_output\windows\server_running.png")
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Desktop screenshot saved"

      - name: Create status file
        run: |
          @"
          X11 Apps Test - Windows
          =======================

          Note: Native X11 client applications (xclock, xeyes, etc.) are not available
          on Windows as MSYS2/MinGW does not provide X11 client libraries.

          This job verifies that:
          1. x11anywhere compiles successfully with Windows backend
          2. The server starts and listens on the configured port

          For actual X11 protocol testing on Windows, see the visual_test.rs tests
          which use Rust-based X11 protocol testing.
          "@ | Out-File -FilePath "xorg_apps_output\windows\status.txt"

      - name: Show server logs
        if: always()
        run: |
          Write-Host "=== Server stdout ==="
          if (Test-Path "C:\temp\x11anywhere_logs\server_stdout.log") {
            Get-Content "C:\temp\x11anywhere_logs\server_stdout.log"
          }
          Write-Host "=== Server stderr ==="
          if (Test-Path "C:\temp\x11anywhere_logs\server_stderr.log") {
            Get-Content "C:\temp\x11anywhere_logs\server_stderr.log"
          }

      - name: Cleanup
        if: always()
        run: |
          Get-Process x11anywhere -ErrorAction SilentlyContinue | Stop-Process -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-windows-screenshots
          path: xorg_apps_output/windows/*
          if-no-files-found: warn

  # Commit screenshots to repository
  commit-xorg-screenshots:
    name: Commit X11 Apps Screenshots
    runs-on: ubuntu-latest
    needs: [xorg-apps-linux, xorg-apps-macos, xorg-apps-windows]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
      needs.xorg-apps-linux.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-linux-screenshots
          path: docs/screenshots/xorg-apps/linux
        continue-on-error: true

      - name: Download macOS screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-macos-screenshots
          path: docs/screenshots/xorg-apps/macos
        continue-on-error: true

      - name: Download Windows screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-windows-screenshots
          path: docs/screenshots/xorg-apps/windows
        continue-on-error: true

      - name: List downloaded files
        run: |
          echo "=== Downloaded screenshots ==="
          find docs/screenshots/xorg-apps -type f 2>/dev/null | head -30 || echo "No files found"

      - name: Commit and push screenshots
        uses: EndBug/add-and-commit@v9
        with:
          add: "docs/screenshots/xorg-apps"
          message: "Update X11 apps test screenshots from CI"
          default_author: github_actions
