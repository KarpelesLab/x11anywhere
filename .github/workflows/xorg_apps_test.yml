name: X11 Apps Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  xorg-apps-linux:
    name: X11 Apps Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            x11-apps \
            x11-utils \
            imagemagick \
            libxcb1-dev \
            libxcb-shm0-dev \
            xterm \
            xfonts-base \
            xfonts-100dpi \
            xfonts-75dpi

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Build x11anywhere
        run: cargo build --release

      - name: Create output directories
        run: |
          mkdir -p xorg_apps_output/linux
          mkdir -p /tmp/x11anywhere_logs

      - name: Start Xvfb (for x11anywhere backend)
        run: |
          # Start Xvfb with -ac (access control disabled) for easier testing
          # Use nohup and redirect stderr to a log file
          nohup Xvfb :99 -screen 0 1280x1024x24 -ac > /tmp/xvfb.log 2>&1 &
          XVFB_PID=$!
          echo "XVFB_PID=$XVFB_PID" >> $GITHUB_ENV
          echo "Started Xvfb with PID $XVFB_PID"

          # Wait for Xvfb to be ready (check for socket)
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if [ -S /tmp/.X11-unix/X99 ]; then
              echo "Xvfb socket is ready"
              break
            fi
            echo "Waiting for Xvfb socket... (attempt $i)"
            sleep 1
          done

          # Verify socket exists
          if [ ! -S /tmp/.X11-unix/X99 ]; then
            echo "ERROR: Xvfb socket not found"
            cat /tmp/xvfb.log || true
            exit 1
          fi

          # Test X11 connectivity
          if DISPLAY=:99 xdpyinfo > /dev/null 2>&1; then
            echo "Xvfb is accepting connections on :99"
          else
            echo "WARNING: xdpyinfo failed, but socket exists - continuing"
          fi

      - name: Start x11anywhere server
        run: |
          # Run server with debug logging using nohup
          nohup env DISPLAY=:99 RUST_LOG=debug ./target/release/x11anywhere -display 50 -tcp > /tmp/x11anywhere_logs/server.log 2>&1 &
          X11ANYWHERE_PID=$!
          echo "X11ANYWHERE_PID=$X11ANYWHERE_PID" >> $GITHUB_ENV
          echo "Started x11anywhere with PID $X11ANYWHERE_PID"

          # Wait for server to start listening
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if ss -tlnp 2>/dev/null | grep -q ":6050 " || netstat -tlnp 2>/dev/null | grep -q ":6050 "; then
              echo "x11anywhere is listening on port 6050"
              break
            fi
            echo "Waiting for server... (attempt $i)"
            sleep 1
          done

          # Show server status
          echo "=== Server log (first 50 lines) ==="
          head -50 /tmp/x11anywhere_logs/server.log || true

          # Check port
          if ss -tlnp 2>/dev/null | grep ":6050 " || netstat -tlnp 2>/dev/null | grep ":6050 "; then
            echo "Server is ready"
          else
            echo "WARNING: Port 6050 not found listening"
            echo "=== Full server log ==="
            cat /tmp/x11anywhere_logs/server.log || true
            # Continue anyway to see what happens
          fi

      - name: Test xclock with detailed logging
        continue-on-error: true
        run: |
          echo "Starting xclock with longer runtime for debugging..."
          # Use localhost:50 to force TCP connection (Unix socket not implemented)
          DISPLAY=localhost:50 xclock -geometry 200x200+50+50 -update 1 &
          XCLOCK_PID=$!
          echo "xclock started with PID $XCLOCK_PID"

          # Wait longer to capture more operations
          sleep 5

          # Check if xclock is still running
          if ps -p $XCLOCK_PID > /dev/null 2>&1; then
            echo "xclock is still running"
          else
            echo "WARNING: xclock has exited"
            wait $XCLOCK_PID 2>/dev/null || true
          fi

          # Capture screenshot via Xvfb
          DISPLAY=:99 import -window root xorg_apps_output/linux/xclock.png || echo "Screenshot capture failed"

          # Show server log at this point to see xclock's requests
          echo "=== Server log after xclock test ==="
          tail -100 /tmp/x11anywhere_logs/server.log | grep -E "RENDER|CreateWindow|MapWindow|PolyArc|FillArc|PolyLine|FillPoly|Expose|opcode" || true

          kill $XCLOCK_PID 2>/dev/null || true
          echo "xclock test completed"

      - name: Test xeyes
        continue-on-error: true
        run: |
          echo "Starting xeyes..."
          DISPLAY=localhost:50 xeyes -geometry 200x150+300+50 &
          XEYES_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xeyes.png || echo "Screenshot capture failed"
          kill $XEYES_PID 2>/dev/null || true
          echo "xeyes test completed"

      - name: Test xlogo
        continue-on-error: true
        run: |
          echo "Starting xlogo..."
          DISPLAY=localhost:50 xlogo -geometry 200x200+550+50 &
          XLOGO_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xlogo.png || echo "Screenshot capture failed"
          kill $XLOGO_PID 2>/dev/null || true
          echo "xlogo test completed"

      - name: Test xcalc
        continue-on-error: true
        run: |
          echo "Starting xcalc..."
          DISPLAY=localhost:50 xcalc -geometry 250x300+50+300 &
          XCALC_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xcalc.png || echo "Screenshot capture failed"
          kill $XCALC_PID 2>/dev/null || true
          echo "xcalc test completed"

      - name: Test xterm
        continue-on-error: true
        run: |
          echo "Starting xterm..."
          DISPLAY=localhost:50 xterm -geometry 80x24+350+300 -e "echo 'Hello from xterm running on x11anywhere!'; sleep 5" &
          XTERM_PID=$!
          sleep 2
          DISPLAY=:99 import -window root xorg_apps_output/linux/xterm.png || echo "Screenshot capture failed"
          kill $XTERM_PID 2>/dev/null || true
          echo "xterm test completed"

      - name: Test multiple apps together
        continue-on-error: true
        run: |
          echo "Starting multiple apps..."
          DISPLAY=localhost:50 xclock -geometry 150x150+50+50 &
          PID1=$!
          DISPLAY=localhost:50 xeyes -geometry 150x100+250+50 &
          PID2=$!
          DISPLAY=localhost:50 xlogo -geometry 150x150+450+50 &
          PID3=$!
          sleep 3
          DISPLAY=:99 import -window root xorg_apps_output/linux/multiple_apps.png || echo "Screenshot capture failed"
          kill $PID1 $PID2 $PID3 2>/dev/null || true
          echo "multiple apps test completed"

      - name: Show server logs
        if: always()
        run: |
          echo "=== x11anywhere server log (full) ==="
          cat /tmp/x11anywhere_logs/server.log || true

          echo ""
          echo "=== RENDER extension operations summary ==="
          grep -c "RENDER:" /tmp/x11anywhere_logs/server.log || echo "No RENDER operations"

          echo ""
          echo "=== Unhandled opcodes ==="
          grep -E "Unhandled|Unknown|not implemented" /tmp/x11anywhere_logs/server.log || echo "None"

      - name: Cleanup
        if: always()
        run: |
          kill $X11ANYWHERE_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-linux-screenshots
          path: xorg_apps_output/linux/*.png
          if-no-files-found: warn

  xorg-apps-macos:
    name: X11 Apps Test (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install XQuartz and X11 apps
        run: |
          # Install XQuartz which provides X11 libraries
          brew install --cask xquartz
          # Install X11 apps via Homebrew
          brew install xorg-apps || true
          # The libs are in /opt/X11 after XQuartz install

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Setup Swift
        run: swift --version

      - name: Build Swift backend
        run: |
          cd swift
          swift build -c release

      - name: Build x11anywhere
        run: cargo build --release --features backend-macos

      - name: Create output directories
        run: |
          mkdir -p xorg_apps_output/macos
          mkdir -p /tmp/x11anywhere_logs

      - name: Start x11anywhere server
        run: |
          RUST_LOG=info ./target/release/x11anywhere -display 50 -tcp > /tmp/x11anywhere_logs/server.log 2>&1 &
          echo "X11ANYWHERE_PID=$!" >> $GITHUB_ENV
          sleep 5
          echo "x11anywhere server started"

      - name: Test with X11 apps (if available)
        run: |
          # Check if XQuartz X11 apps are available
          if [ -x /opt/X11/bin/xclock ]; then
            echo "Starting xclock..."
            # Use localhost:50 to force TCP connection (Unix socket not implemented)
            DISPLAY=localhost:50 /opt/X11/bin/xclock -geometry 200x200+50+50 &
            XCLOCK_PID=$!
            sleep 3
            # Use macOS screencapture
            screencapture -x xorg_apps_output/macos/xclock.png
            kill $XCLOCK_PID 2>/dev/null || true
          else
            echo "XQuartz apps not found, skipping X11 app tests"
            # Create placeholder
            echo "XQuartz not available" > xorg_apps_output/macos/not_available.txt
          fi

      - name: Test xeyes (if available)
        run: |
          if [ -x /opt/X11/bin/xeyes ]; then
            echo "Starting xeyes..."
            # Use localhost:50 to force TCP connection (Unix socket not implemented)
            DISPLAY=localhost:50 /opt/X11/bin/xeyes -geometry 200x150+300+50 &
            XEYES_PID=$!
            sleep 2
            screencapture -x xorg_apps_output/macos/xeyes.png
            kill $XEYES_PID 2>/dev/null || true
          fi
        continue-on-error: true

      - name: Show server logs
        if: always()
        run: |
          echo "=== x11anywhere server log ==="
          cat /tmp/x11anywhere_logs/server.log || true

      - name: Cleanup
        if: always()
        run: kill $X11ANYWHERE_PID 2>/dev/null || true

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-macos-screenshots
          path: xorg_apps_output/macos/*
          if-no-files-found: warn

  xorg-apps-windows:
    name: X11 Apps Test (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Cygwin with X11 packages
        uses: cygwin/cygwin-install-action@master
        with:
          packages: >-
            xorg-server
            xinit
            xeyes
            xlogo
            xclock
            xterm
            libX11-devel

      - name: Setup Rust
        shell: pwsh
        run: rustup default stable

      - name: Build x11anywhere (Windows native)
        shell: pwsh
        run: cargo build --release --features backend-windows

      - name: Create output directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path xorg_apps_output/windows
          New-Item -ItemType Directory -Force -Path C:\temp\x11anywhere_logs

      - name: Add firewall rule for x11anywhere
        shell: pwsh
        run: |
          Write-Host "Adding firewall rule for x11anywhere on port 6050..."
          New-NetFirewallRule -DisplayName "x11anywhere" -Direction Inbound -Protocol TCP -LocalPort 6050 -Action Allow -ErrorAction SilentlyContinue
          Write-Host "Firewall rule added"

      - name: Start x11anywhere server
        shell: pwsh
        run: |
          $env:RUST_LOG = "debug"

          # Start process with cmd.exe to redirect output to file
          $process = Start-Process -FilePath "cmd.exe" `
            -ArgumentList "/c", "set RUST_LOG=debug && $pwd\target\release\x11anywhere.exe -display 50 -tcp > C:\temp\x11anywhere_logs\stdout.log 2>&1" `
            -PassThru `
            -WindowStyle Hidden

          Write-Host "Started x11anywhere with PID: $($process.Id)"
          echo "X11ANYWHERE_PID=$($process.Id)" >> $env:GITHUB_ENV

          # Wait for server to start
          Start-Sleep -Seconds 5

          # Show initial log output
          Write-Host "=== Initial server output ==="
          if (Test-Path "C:\temp\x11anywhere_logs\stdout.log") {
            Get-Content "C:\temp\x11anywhere_logs\stdout.log"
          } else {
            Write-Host "No log file yet"
          }

          # Check if process is still running
          $proc = Get-Process -Name x11anywhere -ErrorAction SilentlyContinue
          if (-not $proc) {
            Write-Host "WARNING: x11anywhere process may have exited"
          } else {
            Write-Host "Process is running with PID: $($proc.Id)"
          }

          # Check if port is listening
          for ($i = 1; $i -le 10; $i++) {
            $listening = netstat -an | Select-String "6050" | Select-String "LISTENING"
            if ($listening) {
              Write-Host "Server is listening on port 6050"
              break
            }
            Write-Host "Waiting for server to start (attempt $i)..."
            Start-Sleep -Seconds 1
          }

      - name: Check x11anywhere process status
        shell: pwsh
        run: |
          Write-Host "=== Checking x11anywhere process status ==="
          $proc = Get-Process -Name x11anywhere -ErrorAction SilentlyContinue
          if ($proc) {
            Write-Host "x11anywhere process is running with PID: $($proc.Id)"
          } else {
            Write-Host "WARNING: x11anywhere process is NOT running!"
            Write-Host "=== Server log output ==="
            if (Test-Path "C:\temp\x11anywhere_logs\stdout.log") {
              Get-Content "C:\temp\x11anywhere_logs\stdout.log"
            } else {
              Write-Host "No log file found"
            }
            Write-Host "=== netstat for port 6050 ==="
            netstat -an | Select-String "6050"
          }

      - name: Test TCP connectivity from PowerShell
        shell: pwsh
        run: |
          Write-Host "=== Testing TCP connectivity from PowerShell (native) ==="
          try {
            $client = New-Object System.Net.Sockets.TcpClient
            $client.Connect("127.0.0.1", 6050)
            Write-Host "SUCCESS: PowerShell can connect to 127.0.0.1:6050"
            $client.Close()
          } catch {
            Write-Host "FAILED: PowerShell cannot connect to 127.0.0.1:6050 - $_"
          }
        continue-on-error: true

      - name: Test TCP connectivity from Cygwin
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail -o igncr '{0}'
        run: |
          echo "=== Testing TCP connectivity from Cygwin ==="
          echo "Checking if port 6050 is reachable..."

          # Test with bash TCP
          if timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/6050" 2>/dev/null; then
            echo "SUCCESS: Can connect to 127.0.0.1:6050 via bash /dev/tcp"
          else
            echo "FAILED: Cannot connect to 127.0.0.1:6050 via bash /dev/tcp"
          fi

          # Try calling Windows native netstat from Cygwin
          echo "=== Windows netstat from Cygwin ==="
          /cygdrive/c/Windows/System32/netstat.exe -an | grep 6050 || echo "Port 6050 not visible"

          # Try connecting with PowerShell from Cygwin
          echo "=== Testing with PowerShell from Cygwin ==="
          powershell.exe -Command "Test-NetConnection -ComputerName 127.0.0.1 -Port 6050" 2>&1 || echo "PowerShell test failed"
        continue-on-error: true

      - name: Test xeyes
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail -o igncr '{0}'
        run: |
          export DISPLAY=127.0.0.1:50
          echo "DISPLAY=$DISPLAY"
          echo "Starting xeyes..."
          /usr/bin/xeyes -geometry 150x100+50+50 &
          XEYES_PID=$!
          sleep 3
          echo "xeyes running with PID $XEYES_PID"
        continue-on-error: true

      - name: Test xlogo
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail -o igncr '{0}'
        run: |
          export DISPLAY=127.0.0.1:50
          echo "Starting xlogo..."
          /usr/bin/xlogo -geometry 150x150+250+50 &
          XLOGO_PID=$!
          sleep 3
          echo "xlogo running with PID $XLOGO_PID"
        continue-on-error: true

      - name: Test xclock
        shell: C:\cygwin\bin\bash.exe --login -eo pipefail -o igncr '{0}'
        run: |
          export DISPLAY=127.0.0.1:50
          echo "Starting xclock..."
          /usr/bin/xclock -geometry 150x150+450+50 &
          XCLOCK_PID=$!
          sleep 3
          echo "xclock running with PID $XCLOCK_PID"
        continue-on-error: true

      - name: Copy server logs
        shell: pwsh
        run: |
          Write-Host "=== Server log output ==="
          if (Test-Path "C:\temp\x11anywhere_logs\stdout.log") {
            Get-Content "C:\temp\x11anywhere_logs\stdout.log"
            Copy-Item "C:\temp\x11anywhere_logs\stdout.log" "xorg_apps_output\windows\server.log"
          } else {
            Write-Host "No server log found"
          }
        continue-on-error: true

      - name: Capture desktop screenshot
        shell: pwsh
        run: |
          Start-Sleep -Seconds 2
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $bitmap = New-Object System.Drawing.Bitmap($screen.Bounds.Width, $screen.Bounds.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($screen.Bounds.Location, [System.Drawing.Point]::Empty, $screen.Bounds.Size)
          $bitmap.Save("xorg_apps_output\windows\xorg_apps.png")
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Desktop screenshot saved"

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          Get-Process x11anywhere -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process xclock -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process xeyes -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Process xlogo -ErrorAction SilentlyContinue | Stop-Process -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: xorg-apps-windows-screenshots
          path: xorg_apps_output/windows/*
          if-no-files-found: warn

  # Commit screenshots to repository
  commit-xorg-screenshots:
    name: Commit X11 Apps Screenshots
    runs-on: ubuntu-latest
    needs: [xorg-apps-linux, xorg-apps-macos, xorg-apps-windows]
    if: |
      always() &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
      needs.xorg-apps-linux.result == 'success'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-linux-screenshots
          path: docs/screenshots/xorg-apps/linux
        continue-on-error: true

      - name: Download macOS screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-macos-screenshots
          path: docs/screenshots/xorg-apps/macos
        continue-on-error: true

      - name: Download Windows screenshots
        uses: actions/download-artifact@v4
        with:
          name: xorg-apps-windows-screenshots
          path: docs/screenshots/xorg-apps/windows
        continue-on-error: true

      - name: List downloaded files
        run: |
          echo "=== Downloaded screenshots ==="
          find docs/screenshots/xorg-apps -type f 2>/dev/null | head -30 || echo "No files found"

      - name: Commit and push screenshots
        uses: EndBug/add-and-commit@v9
        with:
          add: "docs/screenshots/xorg-apps"
          message: "Update X11 apps test screenshots from CI"
          default_author: github_actions
          pull: '--rebase --autostash'
